---
title: "TimeMachine Backups on a Raspberry Pi"
date: 2020-09-02
draft: true
slug: tm-rpi
city: Joinville
---

TimeMachine is maybe the backup tool with the best usability out there. Just choose the HD and let it work... and then use that cool UI to go back in time, or recover your macOS from it. **Sounds amazing**!

Anyway, it was also supposed to be easy to do backups over network, hence [TimeCapsule](https://en.wikipedia.org/wiki/AirPort_Time_Capsule) - which Apple discontinued 2018. In hindsight, I should probably have considered as a tip to not mess with this crap.

# Goal

I wanted to have backups here so me and my wife could use them easily without having to remember to backup whatever is outside iCloud.

A lot of NAS solutions (like Synology, OpenMediaVault, OpenNAS and such) claim to support this. Probably the cheapest one for a basic setup would be a Raspberry Pi running OpenMediaVault, so I went with that at first.

I already had a Raspberry Pi 3, but I thought it was too slow (USB-2), so I got a Raspberry Pi 4, just for this. I already had an external hard drive, and my initial idea was to use a single HD, at least until I know it works.

# Problems

Although it sounds like a great piece of technology, underneath, the TimeMachine thing [is just hard links all over the place](https://arstechnica.com/gadgets/2016/06/zfs-the-other-new-apple-file-system-that-almost-was-until-it-wasnt/), so its probably bound to break at some point...

Anyway, it seems to be worse outside the Apple magic world.

Putting in another words, it is the closest thing to dumpster fire I have ever seem, besides, you know, a real dumpster fire.

Pretty much all the 4324234 tutorials out there will instruct you to use ext4 and SMB (and most of them have different SMB configs), since Apple deprecated AFP (the original protocol). 

NAS softwares usually have a nice "enable TimeMachine support" checkbox on the SMB share configuration.

Nevertheless, after a couple of backups, it gets corrupted.

**Every.**

**Fuckin.**

**Time.**

Also, how can I trust a backup that.. you know, fail every now and then?

# Looking for alternatives

I found something that more or less works:

- forget SMB
- forget ext4
- embrace "deprecated technology" that Apple still uses and supports

## Prepare the disk

Plug the hard drive on your Mac and create a HFS partition (will show as `Mac OS Extended (Case-sensitive, Journaled)`):

![Creating the partition (not the real disk I used though).](/public/images/tm-rpi/0fe282e2-ddab-4026-81a7-ebc7eaee224e.png)

## Install stuff

On the RPI, we are going to need some software installed, so while we are at it, let's install everything at once:

```bash
sudo apt update
sudo apt install hfsprogs netatalk hdparm
```

## Setup mountpoints and hdparm

Plug the HD to your Raspberry, and add this to your `/etc/fstab`:

```bash
sudo fdisk -l # check the partition, will probably be /dev/sda2, as /dev/sda1 will be "EFI System"
echo "/dev/sda2 /mnt/disk1/ hfsplus rw,force 0 0" | sudo tee -a /etc/fstab
```

Let's also setup `hdparm`:

```bash
echo "
/dev/sda2 {
        spindown_time = 120
}
" | sudo tee -a /etc/hdparm.conf
```

Then, let's create the needed folders, permissions and whatnot:

```bash
sudo mkdir -p /mnt/disk1/timemachine /mnt/disk1/homes
sudo chmod -R 777 /mnt/disk1 # fuck it
sudo useradd carlos -M -s /sbin/nologin # use the same username as in your mac
# add as many users as needed here
```

Now, let's mount things:

```bash
sudo mount -a
sudo -u carlos touch /mnt/disk1/whatever # this should work
rm -f /mnt/disk1/whatever
```

## Setup netatalk

To wire it all together, we need to setup `netatalk`.

This can be done by editing  `/etc/netatalk/afp.conf`:

```bash
sudo cp /etc/netatalk/afp.conf{,.backup}
echo "[Global]
 mimic model = TimeCapsule6,106
 log level = default:warn
 log file = /var/log/afpd.log

[Homes]
 basedir regex = /mnt/disk1/homes

[TimeMachine]
 path = /mnt/disk1/timemachine
 time machine = yes
 valid users = carlos
" | sudo tee /etc/netatalk/afp.conf
```

Don't forget to change the `valid users` section (and `path` if you're using a different structure).

After that, we can finally start the service:

```bash
sudo systemctl start netatalk
```

The disk should now show up in the Time Machine setup:

![TimeMachine setup on macOS.](/public/images/tm-rpi/7a178609-b44b-4daa-b81c-60533d0ba8a5.png)

And that should be it.

So far, the less broken setup I was able to make work.

# And... does this even work?

Well, at first, I tried it with a ext4 partition, which corrupted my backups after 1 week, meaning it already last 5 days more than the previous SMB + ext4 approach.

I'm now trying it HFS+ for a couple of days, no problems yet, but I'll update the post.
